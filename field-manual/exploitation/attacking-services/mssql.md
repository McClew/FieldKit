---
layout:
  width: default
  title:
    visible: true
  description:
    visible: false
  tableOfContents:
    visible: true
  outline:
    visible: true
  pagination:
    visible: false
  metadata:
    visible: true
---

# MSSQL

## **Misconfigurations**

### Anonymous Authentication

Misconfigured authentication in SQL Servers can let attackers access the service without credentials if anonymous access is enabled, a user without a password is configured, or any user, group, or machine is allowed to access the SQL Server.

### **Privileges**

Depending on the user's privileges, we may be able to perform different actions within a SQL Server, such as:

* Read or change the contents of a database
* Read or change the server configuration
* Execute commands
* Read local files
* Communicate with other databases
* Capture the local system hash
* Impersonate existing users
* Gain access to other networks

### xp\_cmdshell

xp\_cmdshell acts as a bridge between the SQL Server environment and the underlying operating system. It essentially opens a command shell - like `cmd.exe` - and allows users to run commands within that shell.

{% hint style="info" %}
This feature is **disabled** by default.
{% endhint %}

Enabling this feature can lead to code execution if improperly configured.

Other security considerations include:

* **Restricted Access:** When enabled, access to xp\_cmdshell is typically restricted to members of the **sysadmin** server role.&#x20;
* **Proxy Account:** For non-sysadmin users, you can configure a proxy account using **sp\_xp\_cmdshell\_proxy\_account** to limit the permissions under which xp\_cmdshell commands are executed.&#x20;
* **Auditing:** Regularly auditing xp\_cmdshell usage is crucial to identify and prevent potential security breaches.&#x20;

## Command Execution

### xp\_cmdshell

MSSQL has a [extended stored procedures](https://docs.microsoft.com/en-us/sql/relational-databases/extended-stored-procedures-programming/database-engine-extended-stored-procedures-programming?view=sql-server-ver15) called [xp\_cmdshell](https://docs.microsoft.com/en-us/sql/relational-databases/system-stored-procedures/xp-cmdshell-transact-sql?view=sql-server-ver15) which allow users to execute system commands using SQL.

* `xp_cmdshell` is a powerful feature and disabled by default. `xp_cmdshell` can be enabled and disabled by using the [Policy-Based Management](https://docs.microsoft.com/en-us/sql/relational-databases/security/surface-area-configuration) or by executing [sp\_configure](https://docs.microsoft.com/en-us/sql/database-engine/configure-windows/xp-cmdshell-server-configuration-option).
* The Windows process spawned by `xp_cmdshell` has the same security rights as the SQL Server service account.
* `xp_cmdshell` operates synchronously. Control is not returned to the caller until the command-shell command is completed.

To execute commands using SQL syntax on MSSQL, use:

```sql
1> xp_cmdshell 'whoami'
2> GO

output
-----------------------------
no service\mssql$sqlexpress
NULL
(2 rows affected)
```

If possible an attacker can enable xp\_cmdshell - if they have the appropriate privileges - using the following command:

```sql
-- To allow advanced options to be changed.  
EXECUTE sp_configure 'show advanced options', 1
GO

-- To update the currently configured value for advanced options.  
RECONFIGURE
GO  

-- To enable the feature.  
EXECUTE sp_configure 'xp_cmdshell', 1
GO  

-- To update the currently configured value for this feature.  
RECONFIGURE
GO
```
