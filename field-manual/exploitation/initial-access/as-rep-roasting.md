---
layout:
  width: default
  title:
    visible: true
  description:
    visible: false
  tableOfContents:
    visible: true
  outline:
    visible: true
  pagination:
    visible: false
  metadata:
    visible: true
---

# AS-REP Roasting

In a standard Kerberos login flow, when a user wants to authenticate, they send an "Authentication Service Request" (AS-REQ) to the Domain Controller. Normally, this request must include a timestamp encrypted with the user's password hash. This is called Pre-authentication. It proves the user knows the password before the DC sends back any sensitive data.

When the `DONT_REQ_PREAUTH` flag is set on a user account, the Domain Controller doesn't ask for that proof, it simply sees a request for a username and returns a ticket.

***

## How the Attack Works

{% stepper %}
{% step %}
### The Request

We send an `AS-REQ` to the Domain Controller for a specific user (e.g., `svc-alfresco`), specifically noting that you aren't providing pre-auth data.
{% endstep %}

{% step %}
### The Response (AS-REP)

Because pre-auth is disabled, the DC responds with an `AS-REP`. This message contains a Ticket Granting Ticket (TGT).
{% endstep %}

{% step %}
### The Vulnerability

Crucially, a portion of this `AS-REP` is encrypted using the user’s password hash.
{% endstep %}

{% step %}
### Offline Cracking

Since we have the encrypted data and know the algorithm used, we can use tools like [hashcat.md](../../../toolbox/tooling/password-attacks/hashcat.md "mention") or [johntheripper](../../../toolbox/tooling/password-attacks/johntheripper/ "mention") to guess passwords until one produces the same hash.
{% endstep %}
{% endstepper %}

***

## Why Disable Pre-Authentication?

Usually, it’s for legacy compatibility. Some old applications or service accounts don't support Kerberos pre-authentication. Because it is a "non-default" setting, it is often a sign of a "forgotten" account or an older service, which makes it a prime target.

***

## Getting the Hash

### Using Impacket

`GetNPUsers.py` is the script used to query the Domain Controller for users with pre-authentication disabled.

#### With Valid Credentials

If we already have a low-level account, we can ask the Domain Controller to list _every_ user that has pre-auth disabled and give you their hashes in one go:

```bash
impacket-GetNPUsers <DOMAIN>/<USERNAME> -dc-ip <IP> -no-pass
```

{% code overflow="wrap" %}
```bash
python3 GetNPUsers.py <DOMAIN>/<username>:<password> -request -format hashcat -dc-ip <IP>
```
{% endcode %}

#### Without Credentialed Access

If you only have a list of possible usernames (e.g., `users.txt`), you can spray the DC to see which ones respond without needing a password:

```bash
impacket-GetNPUsers <DOMAIN>/<USERNAME> -dc-ip <IP> -no-pass
```

{% code overflow="wrap" %}
```bash
python3 GetNPUsers.py <DOMAIN>/ -usersfile users.txt -format hashcat -no-pass -dc-ip <IP>
```
{% endcode %}

{% hint style="info" %}
#### Note

The `-format hashcat` flag ensures the output is ready for cracking immediately.
{% endhint %}

***

## Cracking the Hash

Once we have the hash (starts with `$krb5asrep$`), we need to crack it offline.

### Using Hashcat

Mode `18200` is the specific mode for Kerberos 5 AS-REP etype 23 (the most common type you'll see in these attacks).

```bash
hashcat -m 18200 hashes.txt /usr/share/wordlists/rockyou.txt
```
