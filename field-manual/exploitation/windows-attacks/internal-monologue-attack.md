---
layout:
  width: default
  title:
    visible: true
  description:
    visible: false
  tableOfContents:
    visible: true
  outline:
    visible: true
  pagination:
    visible: false
---

# Internal Monologue Attack

_“In secure environments, where Mimikatz should not be executed, an adversary can perform an Internal Monologue Attack, in which they invoke a local procedure call to the_ [_NTLM_](https://en.wikipedia.org/wiki/NT_LAN_Manager) _authentication package (_[_MSV1\_0_](https://learn.microsoft.com/en-us/windows/win32/secauthn/msv1-0-authentication-package)_) from a user-mode application through SSPI to calculate a NetNTLM response in the context of the logged-on user, after performing an extended NetNTLM downgrade.”_ – Elad Shamir

## Proof of Concept:

[https://github.com/eladshamir/Internal-Monologue](https://github.com/eladshamir/Internal-Monologue)

## Prerequisites:

1. **Gain Local Administrator Privileges:** The attacker must first have local administrative access to the target Windows machine.

## Process:

1. **Downgrade NTLM Authentication** (if NTLMv1 is not allowed)**:**
   * Many modern Windows systems are configured to prefer or exclusively use NTLMv2, which is more resistant to cracking than NTLMv1.
   * You may need to modify specific registry keys (`LMCompatibilityLevel`, `NTLMMinClientSec`, and `RestrictSendingNTLMTraffic`) to force the system to allow or prefer NTLMv1 authentication. This is often referred to as a "NetNTLM Downgrade Attack" in the context of Internal Monologue.
   * **Note:** This registry modification is a key indicator that security products might detect, even if LSASS isn't touched.
2. **Retrieve Non-Network Logon Tokens & Impersonate Users:**
   * Identify and retrieve non-network logon tokens from currently running processes on the system. These tokens represent the security context of users who are logged on locally (e.g., via console, RDP, or cached credentials).
   * Impersonate these users' security contexts.
3. **Invoke Local NTLM Authentication Call (SSPI):**
   * For each impersonated user, make a local procedure call to the NTLM authentication package (**MSV1\_0**) through the **Security Support Provider Interface (SSPI)**.
   * Provide a known "challenge" (a random nonce) to this local authentication package.
   * Because you are operating _locally_ and in the _impersonated user's security context_, the NTLM authentication package processes this challenge using the impersonated user's NTLM hash as the key.
   * This process generates a NetNTLMv1 (or NTLMv2, depending on the downgrade success) response _locally_ on the system. Crucially, this communication does _not_ go over the network, making it harder to detect via network monitoring.
4. **Capture the NTLM Response:** The attacker captures the generated NetNTLMv1 (or NTLMv2) response.

## Post-Exploitation:

* **Crack the NTLM Hash:** The captured NetNTLMv1 response is highly susceptible to cracking, often using rainbow tables or brute-force tools like Hashcat or John the Ripper. The weakness of NTLMv1 means that cracking the NTLM hash from the response is significantly easier and faster than cracking the original password directly.
* **Utilise the NTLM Hash (Pass-the-Hash):** Once the NTLM hash is recovered, use it in a "Pass-the-Hash" (PtH) attack to authenticate to other systems on the network as the compromised user, without needing the plaintext password.

## Defence:

Attempting to discover any alerting related to the Internal Monologue attack is going to be tough to find. Some areas to look at are:

* execution of the attack (PowerShell / C# file)
* registry modification of the following keys:
  * LMCompatibilityLevel
  * NTLMMinClientSec
  * RestrictSendingNTLMTraffic
