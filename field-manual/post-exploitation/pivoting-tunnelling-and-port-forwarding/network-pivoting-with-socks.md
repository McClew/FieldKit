---
layout:
  width: default
  title:
    visible: true
  description:
    visible: false
  tableOfContents:
    visible: true
  outline:
    visible: true
  pagination:
    visible: false
  metadata:
    visible: true
---

# Network Pivoting with SOCKS

When a compromised host has multiple network interfaces - one connected to the attack host and one connected to an internal, inaccessible network - dynamic port forwarding is used to pivot into the new network segment.

Since the attack host lacks routes to this internal network, pivoting is achieved by performing [ssh-dynamic-port-forwarding.md](ssh-dynamic-port-forwarding.md "mention") and routing packets via the compromised server. This process is known as [ssh-tunnelling.md](ssh-tunnelling.md "mention") over SOCKS proxy.

SOCKS (Socket Secure) is a protocol that routes network traffic through a SOCKS server - established on the compromised host - on behalf of the connected client (the attack host). [socks-proxy-pivoting.md](socks-proxy-pivoting.md "mention") is effective for circumventing firewall restrictions and establishing routes from NAT networks.

***

## Walkthrough

{% stepper %}
{% step %}
### Enabling Dynamic Port Forwarding with SSH

We must start an SSH client on the attack host and request the SSH server (the compromised host) to allow sending TCP data over the SSH socket. The `-D` argument requests the SSH server to enable dynamic port forwarding.

```bash
ssh -D 9050 ubuntu@10.129.202.64
```

This command starts listening on `localhost:9050` (on the attack host). Any data sent to this local port will be broadcasted to the target internal network (`172.16.5.0/23`) over the SSH tunnel.
{% endstep %}

{% step %}
### Configuring Proxychains

To force tools (like [nmap](../../../toolbox/tooling/information-gathering/network-enumeration/nmap/ "mention") or [metasploit](../../../toolbox/tooling/exploitation-tools/metasploit/ "mention")) to use the SOCKS tunnel, we must use the tool [proxychains.md](../../../toolbox/tooling/network-tools/proxychains.md "mention"). Proxychains redirects TCP connects through SOCKS; or other proxy servers.

To setup [proxychains.md](../../../toolbox/tooling/network-tools/proxychains.md "mention") to work with the SOCKS listener on port `9050`, we need to modify its configuration file (typically located at `/etc/proxychains.conf`). Ensure the SOCKS proxy is specified.

{% code title="Command" %}
```bash
tail -4 /etc/proxychains.conf
```
{% endcode %}

{% code title="Output" %}
```
socks4 127.0.0.1 9050
```
{% endcode %}
{% endstep %}

{% step %}
### Scanning the Internal Network via SOCKS Tunnel

By preceding the scan command with `proxychains` the packets are routed thorugh the local port `9050` and forwarded dynamically via the pivot host - a process called SOCKS tunneling.

{% hint style="warning" %}
#### Important Considerations for Scanning

* We must perform a full TCP connect scan over proxychains, as it cannot understand or correctly handle partial packets (like half connect scans).
* Host-alive checks (traditional pings/ICMP requests) may be blocked by default by firewalls (like Windows Defender), leading to incorrect results against Windows targets. It is often necessary to disable host discovery (`-Pn`) when scanning through proxychains, especially against Windows targets.
{% endhint %}

#### Example Network Scan

```bash
proxychains nmap -v -sn 172.16.5.1-200
```

```
ProxyChains-3.1 (http://proxychains.sf.net)
Host discovery disabled (-Pn). All addresses will be marked 'up' and scan times may be slower.
<SNIP>
Discovered open port 445/tcp on 172.16.5.19 
<SNIP>
Discovered open port 3389/tcp on 172.16.5.19 
```
{% endstep %}

{% step %}
### Pivoting Advanced Tools

The SOCKS tunnel established via SSH and utilised by proxychains can also route traffic for sophisticated exploitation and post-exploitation tools.

#### Using Metasploit

We can start the [metasploit](../../../toolbox/tooling/exploitation-tools/metasploit/ "mention") framework (`msfconsole`) using [proxychains.md](../../../toolbox/tooling/network-tools/proxychains.md "mention") to send all associated traffic through the tunnel. This allows auxiliary modules, such as `rdp_scanner`, to check internal hosts.

```bash
ProxyChains-3.1 (http://proxychains.sf.net)
msf6 > use auxiliary/scanner/rdp/rdp_scanner
msf6 auxiliary(scanner/rdp/rdp_scanner) > set rhosts 172.16.5.19
msf6 auxiliary(scanner/rdp/rdp_scanner) > run
```

The output will show traffic routed via the proxy chain: `|S-chain|-<>-127.0.0.1:9050-<><>-172.16.5.19:3389-<><>-OK`.

#### Using RDP

If the scan reveals an accessible remote desktop service (like RDP on 3389) on an internal target, we can use a client like `xfreerdp` with proxychains to log into the remote host.

```bash
proxychains xfreerdp /v:172.16.5.19 /u:victor /p:pass@123
```

Successful execution will establish an RDP session, pivoting the connection via the compromised server.
{% endstep %}
{% endstepper %}
