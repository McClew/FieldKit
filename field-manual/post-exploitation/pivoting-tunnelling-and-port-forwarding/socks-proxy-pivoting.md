# SOCKS

SOCKS (Socket Secure) proxy pivoting is a technique that allows a cyber security expert to route network traffic through a compromised host, effectively making that host act as a proxy. This process is known as SSH tunneling over SOCKS proxy and is used to pivot network packets when the attack host does not have routes to an internal network segment.

SOCKS is a non-application layer protocol that helps communicate with servers where firewall restrictions are in place. SOCKS proxies are often used to circumvent firewall restrictions and are beneficial because they can pivot by creating a route to an external server even from NAT networks.

***

## SOCKS Protocol Detail

While port forwarding primarily utilizes TCP as the communication layer, SOCKS can be used to encapsulate the forwarded traffic.

* SOCKS 4: This version of the protocol does not support authentication or UDP.
* SOCKS 5: This version provides both authentication and UDP support.

***

## Dynamic Port Forwarding Setup

To initiate a pivot into an internal network, we must perform dynamic port forwarding, which requires the compromised server to act as the SOCKS server.

{% stepper %}
{% step %}
### Enable Dynamic Forwarding

We'll start an SSH client on out attack host and request the SSH server (the compromised machine) to allow sending TCP data over the SSH socket. The `-D` argument requests the SSH server to enable dynamic port forwarding.

```bash
ssh -D 9050 ubuntu@10.129.202.64
```
{% endstep %}

{% step %}
### Result

Once the SSH command is executed, the SSH client starts listening on `localhost:9050` (on our attack machine). All data sent to this local port will be broadcasted to the internal network over the SSH tunnel.
{% endstep %}
{% endstepper %}

***

## Proxychains Config

To force network scanning or exploitation tools to use the established SOCKS tunnel, we'll use the [proxychains.md](../../../toolbox/tooling/network-tools/proxychains.md "mention") tool. Proxychains redirects TCP connections through SOCKS, TOR, or HTTP/HTTPS proxy servers.

Using `proxychains` is effective because it hides the IP address of the requesting host, as the receiving host only sees the IP address of the pivot host. To inform `proxychains` to use the local SOCKS listener on port 9050, modify its configuration file, typically found at `/etc/proxychains.conf`.

```bash
attacker@machine[~]$ tail -4 /etc/proxychains.conf

# meanwile
# defaults set to "tor"
socks4 	127.0.0.1 9050
```

***

## Operational Constraints for Scanning

When scanning or communicating with hosts on the internal network through SOCKS tunneling, specific constraints regarding packet handling must be observed.

1. **Full TCP Connect Scan:** We can only perform a full TCP connect scan when using proxychains, as the tool cannot understand or process partial packets (like half connect scans). Sending partial packets will return incorrect results.
2. **Disabling Host Discovery:** Host-alive checks, which typically use ICMP requests (traditional pings), may be blocked by default by firewalls like Windows Defender. Therefore, when scanning internal Windows targets it is often necessary to disable host discovery using the [nmap](../../../toolbox/tooling/information-gathering/network-enumeration/nmap/ "mention") flag `-Pn`.

### Example Pivoted Scans

Using `proxychains` allows the pivoting of specialised tools, such as [nmap](../../../toolbox/tooling/information-gathering/network-enumeration/nmap/ "mention"), [metasploit](../../../toolbox/tooling/exploitation-tools/metasploit/ "mention"), or RDP clients, across the SOCKS tunnel.

#### Enumerating Internal Targets via Proxychains

```bash
ProxyChains-3.1 (http://proxychains.sf.net)
Host discovery disabled (-Pn). All addresses will be marked 'up' and scan times may be slower.
<SNIP>
|S-chain|-<>-127.0.0.1:9050-<><>-172.16.5.19:445-<><>-OK Discovered open port 445/tcp on 172.16.5.19
|S-chain|-<>-127.0.0.1:9050-<><>-172.16.5.19:3389-<><>-OK Discovered open port 3389/tcp on 172.16.5.19
```

#### Using Metasploit Auxiliary Modules

Metasploit can be started with `proxychains` to run modules like `rdp_scanner` against the pivoted network.

```bash
msf6 auxiliary(scanner/rdp/rdp_scanner) > run
|S-chain|-<>-127.0.0.1:9050-<><>-172.16.5.19:3389-<><>-OK
```

#### Establishing an RDP Session

RDP clients like `xfreerdp` can also leverage the SOCKS tunnel to connect to internal hosts (e.g., 172.16.5.19).

```bash
proxychains xfreerdp /v:172.16.5.19 /u:victor /p:pass@123
```
